<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ•¸ä½è¡Œå‹•é»åæ¿ - ä¿®æ­£ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --group-bg: #e8ecef; --in-camp-bg: #fff9c4; --off-camp-bg: #ffcdd2;
            --primary: #2c3e50; --officer: #ff5252; --nco: #fbc02d; --soldier: #69f0ae;
        }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background-color: #f5f5f5; margin: 0; padding: 0 8px 140px 8px; }

        /* å‡çµçµ±è¨ˆæ¬„ */
        .sticky-header { position: sticky; top: 0; z-index: 1000; background-color: #f5f5f5; padding-top: 8px; padding-bottom: 5px; }
        .summary-table { width: 100%; background: #fff; border-collapse: collapse; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; text-align: center; font-size: 0.75em; }
        .summary-table th { background: #34495e; color: white; padding: 4px; }
        .summary-table td { padding: 6px; font-weight: bold; border: 1px solid #eee; }

        /* æ¨™é¡Œèˆ‡æ’ç‰ˆ */
        .section-header { display: flex; justify-content: space-between; align-items: center; background: var(--primary); color: white; padding: 5px 12px; margin-top: 12px; border-radius: 5px; }
        .section-header button { background: rgba(255,255,255,0.2); color: white; border: 1px solid white; padding: 2px 8px; font-size: 0.75em; }
        .row { display: flex; background: white; border-bottom: 1px solid #ddd; min-height: 50px; }
        .off-row .label { background: var(--off-camp-bg); color: #c62828; }
        .label { width: 65px; background: var(--group-bg); display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.75em; text-align: center; border-right: 2px solid #ccc; padding: 4px; flex-shrink: 0; }
        .in-row .label { background: var(--in-camp-bg); }

        /* äººå“¡å¡ç‰‡ï¼šä¸€æ’ 3-4 å€‹ */
        .drag-zone { flex-grow: 1; padding: 8px; display: grid; grid-template-columns: repeat(auto-fill, minmax(75px, 1fr)); gap: 4px; min-height: 40px; }
        .person-card { padding: 5px 2px; border-radius: 3px; font-size: 0.8em; text-align: center; box-shadow: 1px 1px 2px rgba(0,0,0,0.1); font-weight: bold; border: 1px solid rgba(0,0,0,0.05); }
        .card-officer { background-color: var(--officer); color: white; }
        .card-nco { background-color: var(--nco); color: #222; }
        .card-soldier { background-color: var(--soldier); color: #222; }

        /* åº•éƒ¨æŒ‰éˆ• */
        .btn-container { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 10px 8px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; box-shadow: 0 -2px 15px rgba(0,0,0,0.15); z-index: 1000; }
        .btn-container button { padding: 10px 0; border: none; border-radius: 6px; font-weight: bold; font-size: 0.85em; color: white; }
        .full-row { grid-column: span 3; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

        /* å½ˆçª— */
        #modal, #config-modal, #data-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; box-shadow: 0 0 20px rgba(0,0,0,0.5); z-index: 2000; width: 88%; border-radius: 10px; max-height: 85vh; overflow-y: auto; }
        #overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 1500; }
        textarea { width: 100%; height: 150px; font-family: monospace; font-size: 10px; margin: 10px 0; }
        .config-item { display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; border: 1px solid #ddd; margin-bottom: 8px; padding: 10px; border-radius: 5px; cursor: move; }
    </style>
</head>
<body class="unlocked">

<div class="sticky-header">
    <table class="summary-table">
        <thead><tr><th>é …ç›®</th><th>è»</th><th>å£«</th><th>å…µ</th><th>ç¸½è¨ˆ</th></tr></thead>
        <tbody>
            <tr class="row-header"><td>æ‡‰åˆ°</td><td id="exp-off">0</td><td id="exp-nco">0</td><td id="exp-sol">0</td><td id="exp-total">0</td></tr>
            <tr style="color: #2980b9;"><td>åœ¨ç‡Ÿ</td><td id="act-off">0</td><td id="act-nco">0</td><td id="act-sol">0</td><td id="act-total">0</td></tr>
        </tbody>
    </table>
</div>

<div id="board">
    <div class="section-header"><span>å·¥ä½œçµ„åˆ¥ (åœ¨ç‡Ÿ)</span><button onclick="openConfig('group')">âš™ï¸ ç®¡ç†</button></div>
    <div id="group-area"></div>
    <div class="section-header" style="background:#f39c12;"><span>åœ¨ç‡Ÿäº‹æ•… (é»ƒ)</span><button onclick="openConfig('inCamp')">âš™ï¸ ç®¡ç†</button></div>
    <div id="in-incident-area"></div>
    <div class="section-header" style="background:#d32f2f;"><span>ä¸åœ¨ç‡Ÿäº‹æ•… (ç´…)</span><button onclick="openConfig('offCamp')">âš™ï¸ ç®¡ç†</button></div>
    <div id="off-incident-area"></div>
</div>

<div class="btn-container">
    <button id="lock-btn" onclick="toggleLock()" style="background:#f39c12;">ğŸ”“ è§£é–</button>
    <button onclick="copyReport()" style="background:#8e44ad;">ğŸ“‹ å›å ±</button>
    <button onclick="openModal()" style="background:#27ae60;">ï¼‹ äººå“¡</button>
    <div class="full-row">
        <button onclick="resetAll()" style="background:#2980b9;">âŸ² ä¸€éµæ­¸éšŠ</button>
        <button onclick="openDataModal()" style="background:#34495e;">ğŸ’¾ å‚™ä»½/ç§»è½‰</button>
    </div>
</div>

<div id="overlay" onclick="closeAllModals()"></div>

<div id="modal">
    <h3>äººå“¡ç®¡ç†</h3>
    <input type="hidden" id="edit-id">
    <input type="text" id="p-rank" placeholder="éšç´š"><input type="text" id="p-name" placeholder="å§“å">
    <label>é è¨­çµ„åˆ¥ï¼š</label><select id="p-group"></select>
    <div style="display: flex; justify-content: space-between; margin-top: 10px;">
        <button onclick="savePerson()" style="background:#27ae60; color:white;">å„²å­˜</button>
        <button id="btn-delete" onclick="deletePerson()" style="background:#e74c3c; color:white;">åˆªé™¤</button>
        <button onclick="closeAllModals()">å–æ¶ˆ</button>
    </div>
</div>

<div id="config-modal">
    <h3 id="config-title">ç®¡ç†é †åº</h3>
    <div id="config-list"></div>
    <input type="text" id="new-config-name" placeholder="æ–°å¢åç¨±...">
    <button onclick="addConfigItem()" style="background:#27ae60; color:white; width:100%; padding:10px;">ï¼‹ æ–°å¢é …ç›®</button>
    <button onclick="closeAllModals()" style="width:100%; margin-top: 15px;">å®Œæˆé›¢é–‹</button>
</div>

<div id="data-modal">
    <h3>å‚™ä»½èˆ‡ç§»è½‰</h3>
    <textarea id="data-area"></textarea>
    <button onclick="importData()" style="background:#d32f2f; color:white; width:100%;">ğŸ“¥ åŒ¯å…¥è³‡æ–™</button>
    <button onclick="closeAllModals()" style="width:100%; margin-top: 10px;">é—œé–‰</button>
</div>

<script>
// --- æ ¸å¿ƒé‚è¼¯ ---
function getRankWeight(rank) {
    let w = 0;
    if (rank.includes('æ ¡')) w = 1000; else if (rank.includes('å°‰')) w = 900;
    else if (rank.includes('å£«å®˜é•·')) w = 800; else if (rank.includes('å£«')) w = 700; else if (rank.includes('å…µ')) w = 600;
    if (rank.includes('ä¸Š')) w += 3; else if (rank.includes('ä¸­')) w += 2; else if (rank.includes('ä¸‹') || rank.includes('ä¸€')) w += 1;
    return w;
}

const initialPeople = [
    {id: '1', rank: 'ä¸Šå°‰', name: 'åŠ‰ç‚«è‰¯', home: 'é€£éƒ¨çµ„'}, {id: '2', rank: 'ä¸Šå°‰', name: 'åŠ‰æ†é½Š', home: 'é€£éƒ¨çµ„'}, {id: '3', rank: 'ä¸Šå°‰', name: 'æ—å³»é´»', home: 'é€£éƒ¨çµ„'}, {id: '4', rank: 'ä¸Šå…µ', name: 'ææ•è±ª', home: 'é€£éƒ¨çµ„'}, {id: '5', rank: 'ä¸€å…µ', name: 'èŠè¿¦ç¨‹', home: 'é€£éƒ¨çµ„'},
    {id: '6', rank: 'ä¸Šå£«', name: 'æ—åº­å›', home: 'ç‡Ÿéƒ¨çµ„'}, {id: '7', rank: 'ä¸­å£«', name: 'ç¾…å­å»º', home: 'ç‡Ÿéƒ¨çµ„'}, {id: '8', rank: 'ä¸Šå…µ', name: 'æ—å“²ç”·', home: 'ç‡Ÿéƒ¨çµ„'}, {id: '9', rank: 'ä¸Šå…µ', name: 'å³çªéˆº', home: 'ç‡Ÿéƒ¨çµ„'},
    {id: '10', rank: 'ä¸­å£«', name: 'å³ä»•æ´‹', home: 'é€šä¿¡çµ„'}, {id: '11', rank: 'ä¸‹å£«', name: 'å¼µåŸç‘œ', home: 'é€šä¿¡çµ„'},
    {id: '12', rank: 'ä¸Šå£«', name: 'è¬å€‰ç„', home: 'æ­¦åŒ–çµ„'}, {id: '13', rank: 'ä¸‹å£«', name: 'æ½˜è–éš†', home: 'æ­¦åŒ–çµ„'},
    {id: '14', rank: 'ä¸Šå£«', name: 'é™³é›æ–‡', home: 'é£›é›·çµ„'}, {id: '15', rank: 'ä¸­å£«', name: 'æ›¹äº¨å‰', home: 'é£›é›·çµ„'}, {id: '16', rank: 'ä¸‹å£«', name: 'é¦®åŸºç¤', home: 'é£›é›·çµ„'}, {id: '17', rank: 'ä¸Šå…µ', name: 'è¶™éŸ‹å…’', home: 'é£›é›·çµ„'},
    {id: '18', rank: 'ä¸‹å£«', name: 'é»ƒç‡å¹³', home: 'é€šä¿çµ„'}, {id: '19', rank: 'ä¸€å…µ', name: 'æ—çˆšç’‹', home: 'é€šä¿çµ„'},
    {id: '20', rank: 'ä¸Šå£«', name: 'æ—é›ªè±ª', home: 'CPçµ„'}, {id: '21', rank: 'ä¸Šå£«', name: 'è˜‡ç²¾ç¿°', home: 'CPçµ„'}, {id: '22', rank: 'ä¸­å£«', name: 'æ¢æ–‡é§¿', home: 'CPçµ„'}, {id: '23', rank: 'ä¸‹å£«', name: 'å»–é›…æ•', home: 'CPçµ„'},
    {id: '24', rank: 'å°‘å°‰', name: 'ææ™‰ç‘‹', home: 'ä¿é¤Šæ’'}, {id: '25', rank: 'å£«å®˜é•·', name: 'é™³æ˜±é”', home: 'ä¿é¤Šæ’'}, {id: '26', rank: 'ä¸Šå£«', name: 'é™³æ˜ç¥¥', home: 'ä¿é¤Šæ’'}, {id: '27', rank: 'ä¸Šå£«', name: 'ç‹è³‡æ–‡', home: 'ä¿é¤Šæ’'}, {id: '28', rank: 'ä¸Šå£«', name: 'æ¥Šæƒ é›…', home: 'ä¿é¤Šæ’'}, {id: '29', rank: 'ä¸­å£«', name: 'é„­å»·å¿ ', home: 'ä¿é¤Šæ’'},
    {id: '30', rank: 'ä¸Šå£«', name: 'å´”è¯ç¾©', home: 'å±¥è»Šçµ„'}, {id: '31', rank: 'ä¸‹å£«', name: 'æ½˜ä¸€èª ', home: 'å±¥è»Šçµ„'}, {id: '32', rank: 'ä¸€å…µ', name: 'é¾è±é§¿', home: 'å±¥è»Šçµ„'},
    {id: '33', rank: 'ä¸Šå£«', name: 'å‘¨è¾°è»’', home: 'è¼ªè»Šçµ„'}, {id: '34', rank: 'ä¸­å£«', name: 'åŠ‰çŸç®', home: 'è¼ªè»Šçµ„'}, {id: '35', rank: 'ä¸‹å£«', name: 'æ¢å®¸ç¶®', home: 'è¼ªè»Šçµ„'}, {id: '36', rank: 'ä¸‹å£«', name: 'å”å½¥ä½', home: 'è¼ªè»Šçµ„'}, {id: '37', rank: 'ä¸€å…µ', name: 'è•­ç”«æš¹', home: 'è¼ªè»Šçµ„'}, {id: '38', rank: 'ä¸€å…µ', name: 'é¾”å­å®¸', home: 'è¼ªè»Šçµ„'}, {id: '39', rank: 'ä¸€å…µ', name: 'å·«é€²æ˜‡', home: 'è¼ªè»Šçµ„'},
    {id: '40', rank: 'ä¸­å°‰', name: 'æ½˜å† å®‡', home: 'é†«å‹™çµ„'}, {id: '41', rank: 'ä¸Šå£«', name: 'è”¡æ·‘è³¢', home: 'é†«å‹™çµ„'}, {id: '42', rank: 'ä¸­å£«', name: 'ç‹å»ºè’', home: 'é†«å‹™çµ„'}, {id: '43', rank: 'ä¸‹å£«', name: 'è¬ä½³éœ–', home: 'é†«å‹™çµ„'}, {id: '44', rank: 'äºŒå…µ', name: 'å¼µç§¦ä¸€å“¥', home: 'é†«å‹™çµ„'},
    {id: '45', rank: 'ä¸­å£«', name: 'åŠ‰å“²ç”·', home: 'é£Ÿå‹¤çµ„'}, {id: '46', rank: 'ä¸Šå…µ', name: 'æå»ºç¥¥', home: 'é£Ÿå‹¤çµ„'}, {id: '47', rank: 'ä¸Šå…µ', name: 'æ—é€²é›„', home: 'é£Ÿå‹¤çµ„'},
    {id: '48', rank: 'ä¸Šå£«', name: 'æ¥Šæ†²éœ–', home: 'é è²¡çµ„'}, {id: '49', rank: 'ä¸­å£«', name: 'å»–æ–‡æ——', home: 'é è²¡çµ„'}, {id: '50', rank: 'ä¸­å£«', name: 'æ¨‚èª å¾—', home: 'é è²¡çµ„'},
    {id: '51', rank: 'ä¸Šå…µ', name: 'å®‹æ¤˜å¦¤', home: 'æœªåˆ†é¡'}, {id: '52', rank: 'ä¸­å£«', name: 'é™³é‡‘ç‘‹', home: 'æœªåˆ†é¡'}
];

let config = JSON.parse(localStorage.getItem('attendance_config')) || {
    group: ["é€£éƒ¨çµ„","ç‡Ÿéƒ¨çµ„","é€šä¿¡çµ„","æ­¦åŒ–çµ„","é£›é›·çµ„","é€šä¿çµ„","CPçµ„","ä¿é¤Šæ’","å±¥è»Šçµ„","è¼ªè»Šçµ„","é†«å‹™çµ„","é£Ÿå‹¤çµ„","é è²¡çµ„","æœªåˆ†é¡"],
    inCamp: ["è£œä¼‘", "è¡›å“¨", "æˆ°æƒ…", "èª¿åº¦", "å½ˆè—¥", "è»æ¢°", "å‰²è‰"],
    offCamp: ["ä¼‘å‡", "æ´½å…¬", "å—è¨“", "æ”¯æ´", "æ‹›å‹Ÿ", "è¨—ç®¡"]
};

let people = JSON.parse(localStorage.getItem('attendance_people')) || initialPeople;
let isLocked = false;
let sortableInstances = [];

function renderBoard() {
    const gArea = document.getElementById('group-area');
    const inArea = document.getElementById('in-incident-area');
    const offArea = document.getElementById('off-incident-area');
    const select = document.getElementById('p-group');
    gArea.innerHTML = ''; inArea.innerHTML = ''; offArea.innerHTML = ''; select.innerHTML = '';

    config.group.forEach(g => { gArea.innerHTML += `<div class="row"><div class="label">${g}</div><div class="drag-zone" id="zone-${g}"></div></div>`; select.innerHTML += `<option value="${g}">${g}</option>`; });
    config.inCamp.forEach(i => { inArea.innerHTML += `<div class="row in-row"><div class="label">${i}</div><div class="drag-zone" id="zone-${i}"></div></div>`; });
    config.offCamp.forEach(o => { offArea.innerHTML += `<div class="row off-row"><div class="label">${o}</div><div class="drag-zone" id="zone-${o}"></div></div>`; });

    const pos = JSON.parse(localStorage.getItem('attendance_pos')) || {};
    
    // éæ¿¾é‡è¤‡ ID çš„é‚è¼¯
    const seenIds = new Set();
    people.forEach(p => {
        if (seenIds.has(p.id)) return;
        seenIds.add(p.id);

        const card = document.createElement('div');
        const w = getRankWeight(p.rank);
        let cls = 'card-soldier'; if(w>=900) cls='card-officer'; else if(w>=700) cls='card-nco';
        card.className = `person-card ${cls}`; card.id = `person-${p.id}`; card.innerText = `${p.rank} ${p.name}`;
        card.setAttribute('data-id', p.id); card.setAttribute('data-weight', w);
        card.onclick = (e) => { if(!isLocked) { e.stopPropagation(); openModal(p); } };
        
        let targetId = pos[p.id] || `zone-${p.home}`;
        let targetZone = document.getElementById(targetId);
        
        // é˜²å¤±è¹¤ï¼šå¦‚æœæ‰¾ä¸åˆ°çµ„åˆ¥ï¼Œå¼·è¿«æ”¾åœ¨ç¬¬ä¸€å€‹çµ„åˆ¥
        if (!targetZone && config.group.length > 0) {
            targetId = `zone-${config.group[0]}`;
            targetZone = document.getElementById(targetId);
        }
        
        if(targetZone) targetZone.appendChild(card);
    });

    document.querySelectorAll('.drag-zone').forEach(z => sortChildren(z));
    initSortable(); updateCounts();
}

function sortChildren(c) {
    Array.from(c.children).sort((a,b) => b.dataset.weight - a.dataset.weight).forEach(i => c.appendChild(i));
}

function initSortable() {
    sortableInstances.forEach(i => i.destroy()); sortableInstances = [];
    document.querySelectorAll('.drag-zone').forEach(z => {
        sortableInstances.push(new Sortable(z, { group: 'attendance', animation: 150, scroll: true, forceFallback: true, disabled: isLocked, onEnd: (e) => { sortChildren(e.to); saveAll(); updateCounts(); } }));
    });
}

// --- è¦–è¦ºåŒ–çµ±è¨ˆé‚è¼¯ ---
function updateCounts() {
    let eOff=0, eNco=0, eSol=0, aOff=0, aNco=0, aSol=0;
    
    const seenIds = new Set();
    people.forEach(p => {
        if (seenIds.has(p.id)) return;
        seenIds.add(p.id);
        const w = getRankWeight(p.rank);
        if(w>=900) eOff++; else if(w>=700) eNco++; else eSol++;
    });

    document.querySelectorAll('.person-card').forEach(card => {
        const pId = card.getAttribute('data-id');
        const person = people.find(x => x.id === pId);
        if (!person) return;
        const parentRow = card.closest('.row');
        if (parentRow && !parentRow.classList.contains('off-row')) {
            const w = getRankWeight(person.rank);
            if(w>=900) aOff++; else if(w>=700) aNco++; else aSol++;
        }
    });

    document.getElementById('exp-off').innerText=eOff; document.getElementById('exp-nco').innerText=eNco; document.getElementById('exp-sol').innerText=eSol; document.getElementById('exp-total').innerText=eOff+eNco+eSol;
    document.getElementById('act-off').innerText=aOff; document.getElementById('act-nco').innerText=aNco; document.getElementById('act-sol').innerText=aSol; document.getElementById('act-total').innerText=aOff+aNco+aSol;
}

function toggleLock() { isLocked = !isLocked; document.getElementById('lock-btn').innerText = isLocked ? "ğŸ”’ é–å®š" : "ğŸ”“ è§£é–"; renderBoard(); }

function copyReport() {
    let r = `ã€${new Date().getMonth()+1}/${new Date().getDate()} é»åå›å ±ã€‘\næ‡‰åˆ°ï¼šè»${document.getElementById('exp-off').innerText} å£«${document.getElementById('exp-nco').innerText} å…µ${document.getElementById('exp-sol').innerText} (${document.getElementById('exp-total').innerText})\nåœ¨ç‡Ÿï¼šè»${document.getElementById('act-off').innerText} å£«${document.getElementById('act-nco').innerText} å…µ${document.getElementById('act-sol').innerText} (${document.getElementById('act-total').innerText})\n`;
    config.offCamp.forEach(o => { const cs = document.getElementById(`zone-${o}`).querySelectorAll('.person-card'); if(cs.length>0) r += `â— ${o}(${cs.length}å“¡)ï¼š${Array.from(cs).map(c=>c.innerText.split(' ')[1]).join('ã€')}\n`; });
    navigator.clipboard.writeText(r); alert("å›å ±å·²è¤‡è£½ï¼");
}

function resetAll() { if(confirm("ç¢ºå®šè®“æ‰€æœ‰äººæ­¸éšŠå—ï¼Ÿ")) { localStorage.removeItem('attendance_pos'); renderBoard(); } }

// --- ç®¡ç†å€åŸŸåŠŸèƒ½ (ä¿®æ­£å‡½æ•¸åç¨±) ---
let currentCfgType = '';
function openConfig(type) {
    currentCfgType = type; const list = document.getElementById('config-list'); list.innerHTML = '';
    config[type].forEach((it, idx) => { list.innerHTML += `<div class="config-item"><span>â˜° ${it}</span><button onclick="deleteConfigItem(${idx})" style="background:#e74c3c; color:white; border-radius:3px; padding:4px 8px;">åˆªé™¤</button></div>`; });
    new Sortable(list, { animation: 150, onEnd: () => {
        config[currentCfgType] = Array.from(list.querySelectorAll('span')).map(s => s.innerText.replace('â˜° ',''));
        saveAll(); renderBoard();
    }});
    document.getElementById('config-modal').style.display='block'; document.getElementById('overlay').style.display='block';
}

function addConfigItem() {
    const n = document.getElementById('new-config-name').value;
    if(n) {
        config[currentCfgType].push(n);
        saveAll();
        openConfig(currentCfgType);
        renderBoard();
        document.getElementById('new-config-name').value = '';
    }
}

function deleteConfigItem(idx) {
    if(confirm("ç¢ºå®šåˆªé™¤æ­¤é …ï¼Ÿ")) {
        config[currentCfgType].splice(idx, 1);
        saveAll();
        openConfig(currentCfgType);
        renderBoard();
    }
}

// --- å‚™ä»½èˆ‡äººå“¡ç·¨è¼¯ ---
function openDataModal() {
    const data = { config, people, pos: JSON.parse(localStorage.getItem('attendance_pos')) || {} };
    document.getElementById('data-area').value = JSON.stringify(data);
    document.getElementById('data-modal').style.display='block'; document.getElementById('overlay').style.display='block';
}

function importData() {
    try {
        const d = JSON.parse(document.getElementById('data-area').value);
        if(confirm("åŒ¯å…¥å°‡è¦†è“‹ç›®å‰è³‡æ–™ï¼Œç¢ºå®šå—ï¼Ÿ")) {
            localStorage.setItem('attendance_config', JSON.stringify(d.config));
            localStorage.setItem('attendance_people', JSON.stringify(d.people));
            localStorage.setItem('attendance_pos', JSON.stringify(d.pos));
            location.reload();
        }
    } catch(e) { alert("æ ¼å¼éŒ¯èª¤ï¼"); }
}

function saveAll() { localStorage.setItem('attendance_config', JSON.stringify(config)); localStorage.setItem('attendance_people', JSON.stringify(people)); const p={}; document.querySelectorAll('.person-card').forEach(c => p[c.dataset.id]=c.parentElement.id); localStorage.setItem('attendance_pos', JSON.stringify(p)); }
function closeAllModals() { document.querySelectorAll('#modal, #config-modal, #data-modal, #overlay').forEach(e => e.style.display='none'); }
function openModal(p = null) {
    if(isLocked) return;
    const delBtn = document.getElementById('btn-delete');
    if(p) { document.getElementById('edit-id').value=p.id; document.getElementById('p-rank').value=p.rank; document.getElementById('p-name').value=p.name; document.getElementById('p-group').value=p.home; delBtn.style.display='block'; }
    else { document.getElementById('edit-id').value=''; document.getElementById('p-rank').value=''; document.getElementById('p-name').value=''; delBtn.style.display='none'; }
    document.getElementById('modal').style.display='block'; document.getElementById('overlay').style.display='block';
}
function savePerson() {
    const id=document.getElementById('edit-id').value, r=document.getElementById('p-rank').value, n=document.getElementById('p-name').value, h=document.getElementById('p-group').value;
    if(id) { const i=people.findIndex(x=>x.id===id); people[i]={id, rank:r, name:n, home:h}; } else { people.push({id:Date.now().toString(), rank:r, name:n, home:h}); }
    saveAll(); closeAllModals(); renderBoard();
}
function deletePerson() { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { people=people.filter(x=>x.id!==document.getElementById('edit-id').value); saveAll(); closeAllModals(); renderBoard(); } }

renderBoard();
</script>
</body>
</html>
