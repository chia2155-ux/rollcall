<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ•¸ä½è¡Œå‹•é»åæ¿</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --group-bg: #e8ecef; --in-camp-bg: #fff9c4; --off-camp-bg: #ffcdd2;
            --primary: #2c3e50; --officer: #ff5252; --nco: #fbc02d; --soldier: #69f0ae;
            --female-border: #d32f2f;
        }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background-color: #f5f5f5; margin: 0; padding: 0 8px 180px 8px; }

        .sticky-header { position: sticky; top: 0; z-index: 1000; background-color: #f5f5f5; padding-top: 8px; padding-bottom: 5px; }
        .summary-table { width: 100%; background: #fff; border-collapse: collapse; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; text-align: center; font-size: 0.72em; margin-bottom: 5px; }
        .summary-table th { background: #34495e; color: white; padding: 6px; cursor: pointer; }
        .summary-table td { padding: 6px; font-weight: bold; border: 1px solid #eee; }
        #leave-row { display: none; background-color: #fef9f9; color: #c62828; }

        #search-bar-container { display: none; margin-bottom: 8px; }
        .search-input { width: 100%; padding: 12px; border: 2px solid var(--primary); border-radius: 20px; font-size: 14px; box-sizing: border-box; outline: none; }

        .section-header { display: flex; justify-content: space-between; align-items: center; background: var(--primary); color: white; padding: 5px 12px; margin-top: 12px; border-radius: 5px; }
        .section-header button { background: rgba(255,255,255,0.2); color: white; border: 1px solid white; padding: 2px 8px; font-size: 0.75em; border-radius: 4px; }
        .row { display: flex; background: white; border-bottom: 1px solid #ddd; min-height: 50px; }
        .label { width: 65px; background: var(--group-bg); display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.75em; text-align: center; border-right: 2px solid #ccc; padding: 4px; flex-shrink: 0; }
        .in-row .label { background: var(--in-camp-bg); }
        .off-row .label { background: var(--off-camp-bg); color: #c62828; }

        .drag-zone { flex-grow: 1; padding: 8px; display: grid; grid-template-columns: repeat(auto-fill, minmax(75px, 1fr)); gap: 4px; min-height: 40px; }
        .person-card { padding: 5px 2px; border-radius: 3px; font-size: 0.8em; text-align: center; box-shadow: 1px 1px 2px rgba(0,0,0,0.1); font-weight: bold; border: 1px solid rgba(0,0,0,0.1); position: relative; }
        .card-fixed::after { content: "ğŸ“Œ"; position: absolute; top: -2px; right: -2px; font-size: 8px; }
        .card-female { border: 2.5px solid var(--female-border) !important; box-sizing: border-box; }

        .card-officer { background-color: var(--officer); color: white; }
        .card-nco { background-color: var(--nco); color: #222; }
        .card-soldier { background-color: var(--soldier); color: #222; }

        .btn-container { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 10px 8px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; box-shadow: 0 -2px 15px rgba(0,0,0,0.15); z-index: 1000; }
        .btn-container button { padding: 12px 0; border: none; border-radius: 6px; font-weight: bold; font-size: 0.85em; color: white; }

        #quick-move-hint { display: none; background: #e74c3c; color: white; text-align: center; padding: 5px; font-size: 0.8em; font-weight: bold; }
        #modal, #config-modal, #data-modal, #quick-move-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; box-shadow: 0 0 20px rgba(0,0,0,0.5); z-index: 2000; width: 88%; border-radius: 10px; max-height: 85vh; overflow-y: auto; }
        #overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 1500; }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; box-sizing: border-box; border: 1px solid #ccc; border-radius: 5px; font-size: 16px; }
        .config-item { display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; border: 1px solid #ddd; margin-bottom: 8px; padding: 8px 12px; border-radius: 6px; }
        .drag-handle { cursor: grab; padding: 10px; color: #999; font-size: 1.2em; touch-action: none; }
    </style>
</head>
<body onclick="autoHideSearch()">

<div class="sticky-header">
    <div id="quick-move-hint">âš¡ å¿«é€Ÿç§»å‹•æ¨¡å¼ï¼šé»æ“Šäººå“¡ç§»è‡³ <span id="target-label">?</span></div>
    <table class="summary-table">
        <thead onclick="toggleLeaveRow()">
            <tr><th colspan="5">é»åçµ±è¨ˆè¡¨ (å¥³ç”Ÿä»¥æ‹¬è™Ÿæ¨™ç¤ºï¼Œé»æ­¤å±•é–‹)</th></tr>
            <tr style="background: #455a64; color: white;"><th>é …ç›®</th><th>å®˜</th><th>å£«</th><th>å…µ</th><th>ç¸½è¨ˆ</th></tr>
        </thead>
        <tbody>
            <tr><td>æ‡‰åˆ°</td><td id="exp-off">0(0)</td><td id="exp-nco">0(0)</td><td id="exp-sol">0(0)</td><td id="exp-total">0(0)</td></tr>
            <tr style="color: #2980b9;"><td>åœ¨ç‡Ÿ</td><td id="act-off">0(0)</td><td id="act-nco">0(0)</td><td id="act-sol">0(0)</td><td id="act-total">0(0)</td></tr>
            <tr id="leave-row"><td>ä¼‘å‡</td><td id="lv-off">0(0)</td><td id="lv-nco">0(0)</td><td id="lv-sol">0(0)</td><td id="lv-total">0(0)</td></tr>
        </tbody>
    </table>
    <div id="search-bar-container" onclick="event.stopPropagation()">
        <input type="text" id="search-box" class="search-input" placeholder="ğŸ” æœå°‹å§“åæˆ–éšç´š..." oninput="filterPeople()" onblur="autoHideSearch()">
    </div>
</div>

<div id="board">
    <div class="section-header"><span>å·¥ä½œçµ„åˆ¥ (åœ¨ç‡Ÿ)</span><button onclick="openConfig('group')">âš™ï¸ ç®¡ç†</button></div>
    <div id="group-area"></div>
    <div class="section-header" style="background:#f39c12;"><span>åœ¨ç‡Ÿäº‹æ•… (é»ƒ)</span><button onclick="openConfig('inCamp')">âš™ï¸ ç®¡ç†</button></div>
    <div id="in-incident-area"></div>
    <div class="section-header" style="background:#d32f2f;"><span>ä¸åœ¨ç‡Ÿäº‹æ•… (ç´…)</span><button onclick="openConfig('offCamp')">âš™ï¸ ç®¡ç†</button></div>
    <div id="off-incident-area"></div>
</div>

<div class="btn-container">
    <button onclick="toggleLock(event)" id="lock-btn" style="background:#f39c12;">ğŸ”“ è§£é–</button>
    <button onclick="copyReport()" style="background:#8e44ad;">ğŸ“‹ å›å ±</button>
    <button onclick="openModal()" style="background:#27ae60;">ï¼‹ äººå“¡</button>
    <button onclick="toggleSearch(event)" style="background:#3498db;">ğŸ” æœå°‹</button>
    <button onclick="openQuickMove()" style="background:#e67e22;">âš¡ å¿«é€Ÿ</button>
    <button onclick="openDataModal()" style="background:#34495e;">ğŸ’¾ è¨­å®š</button>
</div>

<div id="overlay" onclick="closeAllModals()"></div>

<div id="quick-move-modal">
    <h3>å¿«é€Ÿç§»å‹•æ¨¡å¼</h3>
    <p style="font-size: 0.8em; color: #666;">é¸æ“‡ç›®æ¨™å€åŸŸï¼Œé»æ“Šçœ‹æ¿ç£éµå³ç§»å‹•ã€‚</p>
    <select id="quick-move-target-select"></select>
    <button onclick="startQuickMove()" style="background:#e67e22; color:white; width:100%; margin-top:10px; padding:12px;">é–‹å•Ÿæ¨¡å¼</button>
    <button onclick="stopQuickMove()" style="background:#7f8c8d; color:white; width:100%; margin-top:10px; padding:12px;">é—œé–‰æ¨¡å¼</button>
</div>

<div id="modal">
    <h3>äººå“¡ç®¡ç†</h3>
    <input type="hidden" id="edit-id">
    <input type="text" id="p-rank" placeholder="éšç´š"><input type="text" id="p-name" placeholder="å§“å">
    <label><input type="checkbox" id="p-female" style="width:auto;"> å¥³æ€§äººå“¡ (ç´…æ¡†æ¨™ç¤º)</label>
    <label>é è¨­çµ„åˆ¥ï¼š</label><select id="p-group"></select>
    <label>å›ºå®šä½ç½®ï¼š</label><select id="p-fixed"><option value="">-- ç„¡å›ºå®š --</option></select>
    <div style="display: flex; justify-content: space-between; margin-top: 20px;">
        <button onclick="savePerson()" style="background:#27ae60; color:white;">å„²å­˜</button>
        <button id="btn-delete" onclick="deletePerson()" style="background:#e74c3c; color:white;">åˆªé™¤</button>
        <button onclick="closeAllModals()">å–æ¶ˆ</button>
    </div>
</div>

<div id="config-modal">
    <h3 id="config-title-text">ç®¡ç†é †åº</h3>
    <div id="config-list-root"></div>
    <div style="display: flex; gap: 5px; margin-top: 15px;">
        <input type="text" id="new-config-name" placeholder="åç¨±..." style="margin: 0;">
        <button onclick="addConfigItem()" style="background:#27ae60; color:white; padding: 0 15px;">ï¼‹</button>
    </div>
    <button onclick="closeAllModals()" style="width:100%; margin-top: 20px; background: #34495e; color: white; padding: 12px 0;">å®Œæˆé›¢é–‹</button>
</div>

<div id="data-modal">
    <h3>æ•¸æ“šèˆ‡ç³»çµ±</h3>
    <textarea id="data-area" placeholder="åœ¨æ­¤åŒ¯å…¥è³‡æ–™..."></textarea>
    <button onclick="importData()" style="background:#d32f2f; color:white; width:100%; margin-bottom: 10px;">ğŸ“¥ åŒ¯å…¥è³‡æ–™</button>
    <button onclick="applyFixedZones()" style="background:#d35400; color:white; width:100%; margin-bottom: 10px;">ğŸ“Œ åŸ·è¡Œå›ºå®šæ´¾æ‹”</button>
    <button onclick="resetAll()" style="background:#2980b9; color:white; width:100%; margin-bottom: 10px;">âŸ² å…¨å“¡æ­¸éšŠ</button>
    <button onclick="factoryReset()" style="background:#7f8c8d; color:white; width:100%;">ğŸ”¥ å¾¹åº•é‡ç½®</button>
    <button onclick="closeAllModals()" style="width:100%; margin-top: 15px;">é—œé–‰</button>
</div>

<script>
// --- åŸºç¤è®Šæ•¸èˆ‡æ¬Šé‡ ---
const defaultConfig = {
    group: ["é€£éƒ¨çµ„","ç‡Ÿéƒ¨çµ„","é€šä¿¡çµ„","æ­¦åŒ–çµ„","é£›é›·çµ„","é€šä¿çµ„","CPçµ„","ä¿é¤Šæ’","å±¥è»Šçµ„","è¼ªè»Šçµ„","é†«å‹™çµ„","é£Ÿå‹¤çµ„","é è²¡çµ„","æœªåˆ†é¡"],
    inCamp: ["è£œä¼‘", "è¡›å“¨", "æˆ°æƒ…", "èª¿åº¦", "å½ˆè—¥", "è»æ¢°", "å‰²è‰"],
    offCamp: ["ä¼‘å‡", "æ´½å…¬", "å—è¨“", "æ”¯æ´", "æ‹›å‹Ÿ", "è¨—ç®¡"]
};
let config = JSON.parse(localStorage.getItem('attendance_config')) || defaultConfig;
let people = JSON.parse(localStorage.getItem('attendance_people')) || [];
let isLocked = false, sortableInstances = [], modalSortable = null, currentCfgType = '';
let quickMoveMode = false, quickMoveTarget = '';

function getRankWeight(rank) {
    let w = 0;
    if (rank.includes('æ ¡')) w = 1000; else if (rank.includes('å°‰')) w = 900;
    else if (rank.includes('å£«å®˜é•·')) w = 800; else if (rank.includes('å£«')) w = 700; else if (rank.includes('å…µ')) w = 600;
    if (rank.includes('ä¸Š')) w += 3; else if (rank.includes('ä¸­')) w += 2; else if (rank.includes('ä¸‹') || rank.includes('ä¸€')) w += 1;
    return w;
}

// --- ä»‹é¢é‚è¼¯ ---
function toggleLeaveRow() { const row = document.getElementById('leave-row'); row.style.display = (row.style.display === 'table-row') ? 'none' : 'table-row'; }
function openQuickMove() {
    const select = document.getElementById('quick-move-target-select'); select.innerHTML = '';
    config.offCamp.forEach(o => select.innerHTML += `<option value="zone-${o}">${o} (ä¸åœ¨ç‡Ÿ)</option>`);
    config.inCamp.forEach(i => select.innerHTML += `<option value="zone-${i}">${i} (åœ¨ç‡Ÿäº‹æ•…)</option>`);
    config.group.forEach(g => select.innerHTML += `<option value="zone-${g}">${g} (ç·¨åˆ¶çµ„åˆ¥)</option>`);
    document.getElementById('quick-move-modal').style.display = 'block'; document.getElementById('overlay').style.display = 'block';
}
function startQuickMove() {
    quickMoveTarget = document.getElementById('quick-move-target-select').value; quickMoveMode = true;
    const label = document.getElementById('quick-move-target-select').options[document.getElementById('quick-move-target-select').selectedIndex].text;
    document.getElementById('target-label').innerText = label; document.getElementById('quick-move-hint').style.display = 'block'; closeAllModals();
}
function stopQuickMove() { quickMoveMode = false; document.getElementById('quick-move-hint').style.display = 'none'; closeAllModals(); }
function handleCardClick(p) { if (quickMoveMode) { const pos = JSON.parse(localStorage.getItem('attendance_pos')) || {}; pos[p.id] = quickMoveTarget; localStorage.setItem('attendance_pos', JSON.stringify(pos)); renderBoard(); } else if(!isLocked) { openModal(p); } }
function toggleSearch(e) { if(e) e.stopPropagation(); const bar = document.getElementById('search-bar-container'); const isHidden = bar.style.display === 'none' || bar.style.display === ''; bar.style.display = isHidden ? 'block' : 'none'; if(isHidden) document.getElementById('search-box').focus(); }
function autoHideSearch() { const box = document.getElementById('search-box'); if (box.value === "") document.getElementById('search-bar-container').style.display = 'none'; }
function filterPeople() { const q = document.getElementById('search-box').value.toLowerCase(); document.querySelectorAll('.person-card').forEach(c => c.style.display = c.innerText.toLowerCase().includes(q) ? 'block' : 'none'); }

// --- æ¸²æŸ“èˆ‡çµ±è¨ˆ (æ ¸å¿ƒä¿®æ­£) ---
function updateCounts() {
    const counts = {
        exp: { off: 0, nco: 0, sol: 0, fOff: 0, fNco: 0, fSol: 0 },
        act: { off: 0, nco: 0, sol: 0, fOff: 0, fNco: 0, fSol: 0 },
        lv:  { off: 0, nco: 0, sol: 0, fOff: 0, fNco: 0, fSol: 0 }
    };

    const seen = new Set();
    people.forEach(p => {
        if (!seen.has(p.id)) {
            seen.add(p.id);
            const w = getRankWeight(p.rank);
            const isF = p.female;
            if (w >= 900) { counts.exp.off++; if(isF) counts.exp.fOff++; }
            else if (w >= 700) { counts.exp.nco++; if(isF) counts.exp.fNco++; }
            else { counts.exp.sol++; if(isF) counts.exp.fSol++; }
        }
    });

    document.querySelectorAll('.person-card').forEach(card => {
        const p = people.find(x => x.id === card.dataset.id);
        if (!p) return;
        const w = getRankWeight(p.rank);
        const isF = p.female;
        const parentZone = card.parentElement.id;
        const parentRow = card.closest('.row');

        // åœ¨ç‡Ÿè¨ˆç®— (ä¸å±¬æ–¼ off-row çš„äººå“¡)
        if (parentRow && !parentRow.classList.contains('off-row')) {
            if (w >= 900) { counts.act.off++; if(isF) counts.act.fOff++; }
            else if (w >= 700) { counts.act.nco++; if(isF) counts.act.fNco++; }
            else { counts.act.sol++; if(isF) counts.act.fSol++; }
        }

        // åƒ…è¨ˆç®—ã€Œä¼‘å‡ã€é€™ä¸€çµ„çš„äººå“¡
        if (parentZone === 'zone-ä¼‘å‡') {
            if (w >= 900) { counts.lv.off++; if(isF) counts.lv.fOff++; }
            else if (w >= 700) { counts.lv.nco++; if(isF) counts.lv.fNco++; }
            else { counts.lv.sol++; if(isF) counts.lv.fSol++; }
        }
    });

    // æ ¼å¼åŒ–é¡¯ç¤º
    const fmt = (total, fem) => `${total}(${fem})`;
    
    document.getElementById('exp-off').innerText = fmt(counts.exp.off, counts.exp.fOff);
    document.getElementById('exp-nco').innerText = fmt(counts.exp.nco, counts.exp.fNco);
    document.getElementById('exp-sol').innerText = fmt(counts.exp.sol, counts.exp.fSol);
    document.getElementById('exp-total').innerText = fmt(counts.exp.off+counts.exp.nco+counts.exp.sol, counts.exp.fOff+counts.exp.fNco+counts.exp.fSol);

    document.getElementById('act-off').innerText = fmt(counts.act.off, counts.act.fOff);
    document.getElementById('act-nco').innerText = fmt(counts.act.nco, counts.act.fNco);
    document.getElementById('act-sol').innerText = fmt(counts.act.sol, counts.act.fSol);
    document.getElementById('act-total').innerText = fmt(counts.act.off+counts.act.nco+counts.act.sol, counts.act.fOff+counts.act.fNco+counts.act.fSol);

    document.getElementById('lv-off').innerText = fmt(counts.lv.off, counts.lv.fOff);
    document.getElementById('lv-nco').innerText = fmt(counts.lv.nco, counts.lv.fNco);
    document.getElementById('lv-sol').innerText = fmt(counts.lv.sol, counts.lv.fSol);
    document.getElementById('lv-total').innerText = fmt(counts.lv.off+counts.lv.nco+counts.lv.sol, counts.lv.fOff+counts.lv.fNco+counts.lv.fSol);
}

function renderBoard() {
    const areas = { group: document.getElementById('group-area'), inCamp: document.getElementById('in-incident-area'), offCamp: document.getElementById('off-incident-area') };
    const selHome = document.getElementById('p-group'), selFix = document.getElementById('p-fixed');
    Object.values(areas).forEach(a => a.innerHTML = '');
    selHome.innerHTML = ''; selFix.innerHTML = '<option value="">-- ç„¡å›ºå®š --</option>';

    config.group.forEach(g => { areas.group.innerHTML += `<div class="row"><div class="label">${g}</div><div class="drag-zone" id="zone-${g}"></div></div>`; selHome.innerHTML += `<option value="${g}">${g}</option>`; selFix.innerHTML += `<option value="zone-${g}">${g}</option>`; });
    config.inCamp.forEach(i => { areas.inCamp.innerHTML += `<div class="row in-row"><div class="label">${i}</div><div class="drag-zone" id="zone-${i}"></div></div>`; selFix.innerHTML += `<option value="zone-${i}">${i}</option>`; });
    config.offCamp.forEach(o => { areas.offCamp.innerHTML += `<div class="row off-row"><div class="label">${o}</div><div class="drag-zone" id="zone-${o}"></div></div>`; selFix.innerHTML += `<option value="zone-${o}">${o}</option>`; });

    const pos = JSON.parse(localStorage.getItem('attendance_pos')) || {};
    people.forEach(p => {
        const card = document.createElement('div');
        const w = getRankWeight(p.rank);
        let colorCls = w>=900?'card-officer':w>=700?'card-nco':'card-soldier';
        card.className = `person-card ${colorCls}${p.female?' card-female':''}${p.fixedZone?' card-fixed':''}`; 
        card.id = `person-${p.id}`; card.innerText = `${p.rank} ${p.name}`;
        card.setAttribute('data-id', p.id); card.setAttribute('data-weight', w);
        card.onclick = (e) => { e.stopPropagation(); handleCardClick(p); };
        let targetId = pos[p.id] || `zone-${p.home}`;
        let targetZone = document.getElementById(targetId) || document.getElementById(`zone-${config.group[0]}`);
        if(targetZone) targetZone.appendChild(card);
    });
    document.querySelectorAll('.drag-zone').forEach(z => { Array.from(z.children).sort((a,b) => b.dataset.weight - a.dataset.weight).forEach(i => z.appendChild(i)); });
    initSortable(); updateCounts(); filterPeople();
}

function initSortable() {
    sortableInstances.forEach(i => i.destroy());
    sortableInstances = Array.from(document.querySelectorAll('.drag-zone')).map(z => 
        new Sortable(z, { group:'attendance', animation:150, forceFallback: true, scroll: true, disabled:isLocked, 
            onEnd: (e) => { Array.from(e.to.children).sort((a,b) => b.dataset.weight - a.dataset.weight).forEach(i => e.to.appendChild(i)); saveAll(); updateCounts(); } 
        })
    );
}

// å…¶é¤˜åŠŸèƒ½ (saveAll, factoryReset, openConfig ç­‰) ä¿æŒä¸è®Š
function saveAll() { localStorage.setItem('attendance_config', JSON.stringify(config)); localStorage.setItem('attendance_people', JSON.stringify(people)); const p={}; document.querySelectorAll('.person-card').forEach(c => p[c.dataset.id]=c.parentElement.id); localStorage.setItem('attendance_pos', JSON.stringify(p)); }
function handleGlobalClick(e) { const bar = document.getElementById('search-bar-container'); const box = document.getElementById('search-box'); if (bar.style.display === 'block' && box.value === '') bar.style.display = 'none'; }
function toggleLock(e) { e.stopPropagation(); isLocked = !isLocked; document.getElementById('lock-btn').innerText = isLocked ? "ğŸ”’ é–å®š" : "ğŸ”“ è§£é–"; renderBoard(); }
function copyReport() {
    let r = `ã€${new Date().getMonth()+1}/${new Date().getDate()} å›å ±ã€‘\næ‡‰åˆ°ï¼šå®˜${document.getElementById('exp-off').innerText} å£«${document.getElementById('exp-nco').innerText} å…µ${document.getElementById('exp-sol').innerText} (${document.getElementById('exp-total').innerText})\nåœ¨ç‡Ÿï¼šå®˜${document.getElementById('act-off').innerText} å£«${document.getElementById('act-nco').innerText} å…µ${document.getElementById('act-sol').innerText} (${document.getElementById('act-total').innerText})\n`;
    config.offCamp.forEach(o => { const cs = document.getElementById(`zone-${o}`).querySelectorAll('.person-card'); if(cs.length>0) r += `â— ${o}(${cs.length}å“¡)ï¼š${Array.from(cs).map(c=>c.innerText.split(' ')[1]).join('ã€')}\n`; });
    const el = document.createElement('textarea'); el.value = r; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el); alert("å›å ±å·²è¤‡è£½ï¼");
}
function resetAll() { if(confirm("ç¢ºå®šå…¨å“¡æ­¸éšŠï¼Ÿ")) { localStorage.removeItem('attendance_pos'); renderBoard(); closeAllModals(); } }
function applyFixedZones() { if(confirm("åŸ·è¡Œå›ºå®šäººå“¡æ´¾æ‹”ï¼Ÿ")) { const pos = JSON.parse(localStorage.getItem('attendance_pos'))||{}; people.forEach(p => {if(p.fixedZone) pos[p.id]=p.fixedZone;}); localStorage.setItem('attendance_pos', JSON.stringify(pos)); renderBoard(); closeAllModals(); } }
function factoryReset() { if(confirm("ç¢ºå®šé‡ç½®ï¼Ÿ")) { localStorage.clear(); location.reload(); } }
function closeAllModals() { document.querySelectorAll('#modal, #config-modal, #data-modal, #overlay, #quick-move-modal').forEach(e => e.style.display='none'); if (modalSortable) { modalSortable.destroy(); modalSortable = null; } }
function openDataModal() { document.getElementById('data-area').value = JSON.stringify({config, people, pos: JSON.parse(localStorage.getItem('attendance_pos'))||{}}); document.getElementById('data-modal').style.display='block'; document.getElementById('overlay').style.display='block'; }
function importData() { try { const d = JSON.parse(document.getElementById('data-area').value); localStorage.setItem('attendance_config', JSON.stringify(d.config)); localStorage.setItem('attendance_people', JSON.stringify(d.people)); localStorage.setItem('attendance_pos', JSON.stringify(d.pos)); location.reload(); } catch(e) { alert("æ ¼å¼éŒ¯èª¤ï¼"); } }
function openModal(p = null) {
    if(isLocked) return;
    const delBtn = document.getElementById('btn-delete');
    if(p) { document.getElementById('edit-id').value=p.id; document.getElementById('p-rank').value=p.rank; document.getElementById('p-name').value=p.name; document.getElementById('p-group').value=p.home; document.getElementById('p-fixed').value=p.fixedZone||""; document.getElementById('p-female').checked = p.female || false; delBtn.style.display='block'; }
    else { document.getElementById('edit-id').value=''; document.getElementById('p-rank').value=''; document.getElementById('p-name').value=''; document.getElementById('p-fixed').value=''; document.getElementById('p-female').checked = false; delBtn.style.display='none'; }
    document.getElementById('modal').style.display='block'; document.getElementById('overlay').style.display='block';
}
function savePerson() {
    const id=document.getElementById('edit-id').value, r=document.getElementById('p-rank').value, n=document.getElementById('p-name').value, h=document.getElementById('p-group').value, f=document.getElementById('p-fixed').value, fem=document.getElementById('p-female').checked;
    if(id) { const i=people.findIndex(x=>x.id===id); people[i]={id, rank:r, name:n, home:h, fixedZone:f, female:fem}; } else { people.push({id:Date.now().toString(), rank:r, name:n, home:h, fixedZone:f, female:fem}); }
    saveAll(); closeAllModals(); renderBoard();
}
function deletePerson() { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { people=people.filter(x=>x.id!==document.getElementById('edit-id').value); saveAll(); closeAllModals(); renderBoard(); } }
function openConfig(type) {
    currentCfgType = type; const root = document.getElementById('config-list-root'); if (modalSortable) { modalSortable.destroy(); modalSortable = null; } root.innerHTML = '';
    const listId = 'list-' + Date.now(); const newList = document.createElement('div'); newList.id = listId; root.appendChild(newList);
    (config[type] || []).forEach((it, idx) => {
        const item = document.createElement('div'); item.className = 'config-item';
        item.innerHTML = `<div class="drag-handle">â˜°</div><div class="cfg-txt" style="flex-grow:1; font-weight:bold;">${it}</div><button onclick="deleteCfg(${idx})" style="background:#e74c3c; color:white; padding:5px 8px; border-radius:4px; font-size:0.8em;">åˆªé™¤</button>`;
        newList.appendChild(item);
    });
    document.getElementById('config-modal').style.display = 'block'; document.getElementById('overlay').style.display = 'block';
    requestAnimationFrame(() => { modalSortable = Sortable.create(newList, { handle: '.drag-handle', animation: 150, forceFallback: true, onEnd: () => { config[currentCfgType] = Array.from(newList.children).map(el => el.querySelector('.cfg-txt').innerText); saveAll(); renderBoard(); }}); });
}
function addConfigItem() { const n = document.getElementById('new-config-name').value; if(n) { config[currentCfgType].push(n); saveAll(); openConfig(currentCfgType); renderBoard(); document.getElementById('new-config-name').value=''; } }
function deleteCfg(idx) { config[currentCfgType].splice(idx, 1); saveAll(); openConfig(currentCfgType); renderBoard(); }

renderBoard();
</script>
</body>
</html>
