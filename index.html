<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ•¸ä½è¡Œå‹•é»åæ¿ - æˆ°æƒ…é–å®šç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --group-bg: #e8ecef;
            --in-camp-bg: #fff9c4;
            --off-camp-bg: #ffcdd2;
            --primary: #2c3e50;
            --officer: #ff5252;
            --nco: #fbc02d;
            --soldier: #69f0ae;
        }

        body { 
            font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; 
            background-color: #f5f5f5; 
            margin: 0; 
            padding: 0 10px 85px 10px; 
        }

        /* å‡çµæ¨™é ­ */
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 1000;
            background-color: #f5f5f5;
            padding-top: 10px;
            padding-bottom: 5px;
        }

        .summary-table {
            width: 100%; background: #fff; border-collapse: collapse;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-radius: 8px; 
            overflow: hidden; text-align: center; font-size: 0.8em;
        }
        .summary-table th { background: #34495e; color: white; padding: 6px; }
        .summary-table td { padding: 8px; font-weight: bold; border: 1px solid #eee; }
        .row-header { background: #f8f9fa; color: #333; }

        .section-title { background: var(--primary); color: white; padding: 8px 15px; font-weight: bold; margin-top: 15px; border-radius: 5px; }
        .title-in { background: #fbc02d; color: #333; }
        .title-off { background: #d32f2f; color: white; }

        .row { display: flex; background: white; border-bottom: 1px solid #ddd; min-height: 60px; }
        .label {
            width: 70px; background: var(--group-bg); display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 0.8em; text-align: center; border-right: 2px solid #ccc; padding: 5px; flex-shrink: 0;
        }
        .in-row .label { background: var(--in-camp-bg); }
        .off-row .label { background: var(--off-camp-bg); }

        .drag-zone { flex-grow: 1; padding: 10px; display: flex; flex-wrap: wrap; gap: 6px; min-height: 50px; }

        /* å¡ç‰‡æ¨£å¼ */
        .person-card {
            padding: 8px 10px; border-radius: 4px; font-size: 0.9em; box-shadow: 1px 1px 2px rgba(0,0,0,0.1);
            font-weight: bold; border: 1px solid rgba(0,0,0,0.1);
        }
        .card-officer { background-color: var(--officer); color: white; }
        .card-nco { background-color: var(--nco); color: #222; }
        .card-soldier { background-color: var(--soldier); color: #222; }

        /* é–å®šç‹€æ…‹ä¸‹çš„å¡ç‰‡æ¸¸æ¨™ */
        .locked .person-card { cursor: default !important; }
        .unlocked .person-card { cursor: grab; }

        /* åº•éƒ¨æŒ‰éˆ• */
        .btn-container {
            position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 10px;
            display: flex; justify-content: space-around; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000;
        }
        button { padding: 10px 12px; border: none; border-radius: 5px; font-weight: bold; font-size: 0.9em; }
        .btn-add { background: #27ae60; color: white; }
        .btn-reset { background: #2980b9; color: white; }
        .btn-lock { background: #f39c12; color: white; min-width: 80px; }
        .btn-lock.is-active { background: #7f8c8d; }

        #modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; box-shadow: 0 0 20px rgba(0,0,0,0.5); z-index: 2000; width: 85%; border-radius: 10px; }
        #overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 1500; }
        input, select { width: 100%; padding: 8px; margin: 10px 0; box-sizing: border-box; }
    </style>
</head>
<body class="unlocked">

<div class="sticky-header">
    <table class="summary-table">
        <thead>
            <tr>
                <th>çµ±è¨ˆ</th><th>è»å®˜</th><th>å£«å®˜</th><th>å£«å…µ</th><th>ç¸½è¨ˆ</th>
            </tr>
        </thead>
        <tbody>
            <tr class="row-header">
                <td>æ‡‰åˆ°</td><td id="exp-off">0</td><td id="exp-nco">0</td><td id="exp-sol">0</td><td id="exp-total">0</td>
            </tr>
            <tr style="color: #2980b9;">
                <td>åœ¨ç‡Ÿ</td><td id="act-off">0</td><td id="act-nco">0</td><td id="act-sol">0</td><td id="act-total">0</td>
            </tr>
        </tbody>
    </table>
</div>

<div id="board">
    <div class="section-title">å·¥ä½œçµ„åˆ¥ (åœ¨ç‡Ÿ)</div>
    <div id="group-area"></div>

    <div class="section-title title-in">åœ¨ç‡Ÿäº‹æ•… (é»ƒ)</div>
    <div id="in-incident-area"></div>

    <div class="section-title title-off">ä¸åœ¨ç‡Ÿäº‹æ•… (ç´…)</div>
    <div id="off-incident-area"></div>
</div>

<div class="btn-container">
    <button class="btn-lock" id="lock-btn" onclick="toggleLock()">ğŸ”“ è§£é–ä¸­</button>
    <button class="btn-add" onclick="openModal()">ï¼‹ æ–°å¢</button>
    <button class="btn-reset" onclick="resetAll()">âŸ² æ­¸éšŠ</button>
</div>

<div id="overlay" onclick="closeModal()"></div>
<div id="modal">
    <h3 id="modal-title">äººå“¡ç®¡ç†</h3>
    <input type="hidden" id="edit-id">
    <label>éšç´šï¼š</label><input type="text" id="p-rank">
    <label>å§“åï¼š</label><input type="text" id="p-name">
    <label>æ‰€å±¬çµ„åˆ¥ï¼š</label><select id="p-group"></select>
    <div style="display: flex; justify-content: space-between; margin-top: 10px;">
        <button onclick="savePerson()" style="background: #27ae60; color:white;">å„²å­˜</button>
        <button id="btn-delete" onclick="deletePerson()" style="background: #e74c3c; color:white; display:none;">åˆªé™¤</button>
        <button onclick="closeModal()">å–æ¶ˆ</button>
    </div>
</div>

<script>
const initialGroups = ["é€£éƒ¨çµ„","ç‡Ÿéƒ¨çµ„","é€šä¿¡çµ„","æ­¦åŒ–çµ„","é£›é›·çµ„","é€šä¿çµ„","CPçµ„","ä¿é¤Šæ’","å±¥è»Šçµ„","è¼ªè»Šçµ„","é†«å‹™çµ„","é£Ÿå‹¤çµ„","é è²¡çµ„","æœªåˆ†é¡"];
// æ–°å¢ã€Œå‰²è‰ã€è‡³åœ¨ç‡Ÿäº‹æ•…
const inCampIncidents = ["è£œä¼‘", "è¡›å“¨", "æˆ°æƒ…", "èª¿åº¦", "å½ˆè—¥", "è»æ¢°", "å‰²è‰"];
const offCampIncidents = ["ä¼‘å‡", "æ´½å…¬", "å—è¨“", "æ”¯æ´", "æ‹›å‹Ÿ", "è¨—ç®¡"];

let people = [
    {id: '1', rank: 'ä¸Šå°‰', name: 'åŠ‰ç‚«è‰¯', home: 'é€£éƒ¨çµ„'}, {id: '2', rank: 'ä¸Šå°‰', name: 'åŠ‰æ†é½Š', home: 'é€£éƒ¨çµ„'}, {id: '3', rank: 'ä¸Šå°‰', name: 'æ—å³»é´»', home: 'é€£éƒ¨çµ„'}, {id: '4', rank: 'ä¸Šå…µ', name: 'ææ•è±ª', home: 'é€£éƒ¨çµ„'}, {id: '5', rank: 'ä¸€å…µ', name: 'èŠè¿¦ç¨‹', home: 'é€£éƒ¨çµ„'},
    {id: '6', rank: 'ä¸Šå£«', name: 'æ—åº­å›', home: 'ç‡Ÿéƒ¨çµ„'}, {id: '7', rank: 'ä¸­å£«', name: 'ç¾…å­å»º', home: 'ç‡Ÿéƒ¨çµ„'}, {id: '8', rank: 'ä¸Šå…µ', name: 'æ—å“²ç”·', home: 'ç‡Ÿéƒ¨çµ„'}, {id: '9', rank: 'ä¸Šå…µ', name: 'å³çªéˆº', home: 'ç‡Ÿéƒ¨çµ„'},
    {id: '10', rank: 'ä¸­å£«', name: 'å³ä»•æ´‹', home: 'é€šä¿¡çµ„'}, {id: '11', rank: 'ä¸‹å£«', name: 'å¼µåŸç‘œ', home: 'é€šä¿¡çµ„'},
    {id: '12', rank: 'ä¸Šå£«', name: 'è¬å€‰ç„', home: 'æ­¦åŒ–çµ„'}, {id: '13', rank: 'ä¸‹å£«', name: 'æ½˜è–éš†', home: 'æ­¦åŒ–çµ„'},
    {id: '14', rank: 'ä¸Šå£«', name: 'é™³é›æ–‡', home: 'é£›é›·çµ„'}, {id: '15', rank: 'ä¸­å£«', name: 'æ›¹äº¨å‰', home: 'é£›é›·çµ„'}, {id: '16', rank: 'ä¸‹å£«', name: 'é¦®åŸºç¤', home: 'é£›é›·çµ„'}, {id: '17', rank: 'ä¸Šå…µ', name: 'è¶™éŸ‹å…’', home: 'é£›é›·çµ„'},
    {id: '18', rank: 'ä¸‹å£«', name: 'é»ƒç‡å¹³', home: 'é€šä¿çµ„'}, {id: '19', rank: 'ä¸€å…µ', name: 'æ—çˆšç’‹', home: 'é€šä¿çµ„'},
    {id: '20', rank: 'ä¸Šå£«', name: 'æ—é›ªè±ª', home: 'CPçµ„'}, {id: '21', rank: 'ä¸Šå£«', name: 'è˜‡ç²¾ç¿°', home: 'CPçµ„'}, {id: '22', rank: 'ä¸­å£«', name: 'æ¢æ–‡é§¿', home: 'CPçµ„'}, {id: '23', rank: 'ä¸‹å£«', name: 'å»–é›…æ•', home: 'CPçµ„'},
    {id: '24', rank: 'å°‘å°‰', name: 'ææ™‰ç‘‹', home: 'ä¿é¤Šæ’'}, {id: '25', rank: 'å£«å®˜é•·', name: 'é™³æ˜±é”', home: 'ä¿é¤Šæ’'}, {id: '26', rank: 'ä¸Šå£«', name: 'é™³æ˜ç¥¥', home: 'ä¿é¤Šæ’'}, {id: '27', rank: 'ä¸Šå£«', name: 'ç‹è³‡æ–‡', home: 'ä¿é¤Šæ’'}, {id: '28', rank: 'ä¸Šå£«', name: 'æ¥Šæƒ é›…', home: 'ä¿é¤Šæ’'}, {id: '29', rank: 'ä¸­å£«', name: 'é„­å»·å¿ ', home: 'ä¿é¤Šæ’'},
    {id: '30', rank: 'ä¸Šå£«', name: 'å´”è¯ç¾©', home: 'å±¥è»Šçµ„'}, {id: '31', rank: 'ä¸‹å£«', name: 'æ½˜ä¸€èª ', home: 'å±¥è»Šçµ„'}, {id: '32', rank: 'ä¸€å…µ', name: 'é¾è±é§¿', home: 'å±¥è»Šçµ„'},
    {id: '33', rank: 'ä¸Šå£«', name: 'å‘¨è¾°è»’', home: 'è¼ªè»Šçµ„'}, {id: '34', rank: 'ä¸­å£«', name: 'åŠ‰çŸç®', home: 'è¼ªè»Šçµ„'}, {id: '35', rank: 'ä¸‹å£«', name: 'æ¢å®¸ç¶®', home: 'è¼ªè»Šçµ„'}, {id: '36', rank: 'ä¸‹å£«', name: 'å”å½¥ä½', home: 'è¼ªè»Šçµ„'}, {id: '37', rank: 'ä¸€å…µ', name: 'è•­ç”«æš¹', home: 'è¼ªè»Šçµ„'}, {id: '38', rank: 'ä¸€å…µ', name: 'é¾”å­å®¸', home: 'è¼ªè»Šçµ„'}, {id: '39', rank: 'ä¸€å…µ', name: 'å·«é€²æ˜‡', home: 'è¼ªè»Šçµ„'},
    {id: '40', rank: 'ä¸­å°‰', name: 'æ½˜å† å®‡', home: 'é†«å‹™çµ„'}, {id: '41', rank: 'ä¸Šå£«', name: 'è”¡æ·‘è³¢', home: 'é†«å‹™çµ„'}, {id: '42', rank: 'ä¸­å£«', name: 'ç‹å»ºè’', home: 'é†«å‹™çµ„'}, {id: '43', rank: 'ä¸‹å£«', name: 'è¬ä½³éœ–', home: 'é†«å‹™çµ„'}, {id: '44', rank: 'äºŒå…µ', name: 'å¼µç§¦ä¸€å“¥', home: 'é†«å‹™çµ„'},
    {id: '45', rank: 'ä¸­å£«', name: 'åŠ‰å“²ç”·', home: 'é£Ÿå‹¤çµ„'}, {id: '46', rank: 'ä¸Šå…µ', name: 'æå»ºç¥¥', home: 'é£Ÿå‹¤çµ„'}, {id: '47', rank: 'ä¸Šå…µ', name: 'æ—é€²é›„', home: 'é£Ÿå‹¤çµ„'},
    {id: '48', rank: 'ä¸Šå£«', name: 'æ¥Šæ†²éœ–', home: 'é è²¡çµ„'}, {id: '49', rank: 'ä¸­å£«', name: 'å»–æ–‡æ——', home: 'é è²¡çµ„'}, {id: '50', rank: 'ä¸­å£«', name: 'æ¨‚èª å¾—', home: 'é è²¡çµ„'},
    {id: '51', rank: 'ä¸Šå…µ', name: 'å®‹æ¤˜å¦¤', home: 'æœªåˆ†é¡'}, {id: '52', rank: 'ä¸­å£«', name: 'é™³é‡‘ç‘‹', home: 'æœªåˆ†é¡'}
];

let sortableInstances = [];
let isLocked = false;

function getRankType(rank) {
    if (rank.includes('å°‰') || rank.includes('æ ¡') || rank.includes('å°‘') || (rank.includes('ä¸­') && rank.length <= 2)) {
        if (rank.includes('ä¸­å£«')) return 'nco';
        return 'off';
    }
    if (rank.includes('å£«') || rank.includes('é•·')) return 'nco';
    return 'sol';
}

function renderBoard() {
    const gArea = document.getElementById('group-area');
    const inArea = document.getElementById('in-incident-area');
    const offArea = document.getElementById('off-incident-area');
    const select = document.getElementById('p-group');
    
    gArea.innerHTML = ''; inArea.innerHTML = ''; offArea.innerHTML = ''; select.innerHTML = '';

    initialGroups.forEach(g => {
        gArea.innerHTML += `<div class="row"><div class="label">${g}</div><div class="drag-zone" id="zone-${g}"></div></div>`;
        select.innerHTML += `<option value="${g}">${g}</option>`;
    });
    inCampIncidents.forEach(i => {
        inArea.innerHTML += `<div class="row in-row"><div class="label">${i}</div><div class="drag-zone" id="zone-${i}"></div></div>`;
    });
    offCampIncidents.forEach(i => {
        offArea.innerHTML += `<div class="row off-row"><div class="label">${i}</div><div class="drag-zone" id="zone-${i}"></div></div>`;
    });

    const savedPos = JSON.parse(localStorage.getItem('attendance_pos')) || {};
    
    people.forEach(p => {
        const card = document.createElement('div');
        const rType = getRankType(p.rank);
        card.className = `person-card card-${rType === 'off' ? 'officer' : rType === 'nco' ? 'nco' : 'soldier'}`;
        card.id = `person-${p.id}`;
        card.innerText = `${p.rank} ${p.name}`;
        card.setAttribute('data-id', p.id);
        card.onclick = (e) => { 
            if(isLocked) return; // é–å®šæ™‚é»æ“Šç„¡æ•ˆ
            e.stopPropagation(); 
            openModal(p); 
        };
        
        const currentZoneId = savedPos[p.id] || `zone-${p.home}`;
        const targetZone = document.getElementById(currentZoneId);
        if (targetZone) targetZone.appendChild(card);
    });

    initSortable();
    updateCounts();
}

function initSortable() {
    // æ¸…é™¤èˆŠå¯¦é«”
    sortableInstances.forEach(i => i.destroy());
    sortableInstances = [];

    document.querySelectorAll('.drag-zone').forEach(zone => {
        const s = new Sortable(zone, {
            group: 'attendance',
            animation: 150,
            scroll: true,
            forceFallback: true,
            scrollSensitivity: 100,
            scrollSpeed: 20,
            disabled: isLocked, // æ ¹æ“šç‹€æ…‹æ±ºå®šæ˜¯å¦ç¦ç”¨
            onEnd: () => { 
                saveAllPositions(); 
                updateCounts(); 
            }
        });
        sortableInstances.push(s);
    });
}

function toggleLock() {
    isLocked = !isLocked;
    const btn = document.getElementById('lock-btn');
    if (isLocked) {
        btn.innerText = "ğŸ”’ é–å®šä¸­";
        btn.classList.add('is-active');
        document.body.classList.replace('unlocked', 'locked');
    } else {
        btn.innerText = "ğŸ”“ è§£é–ä¸­";
        btn.classList.remove('is-active');
        document.body.classList.replace('locked', 'unlocked');
    }
    // æ›´æ–°æ‰€æœ‰æ‹–æ‹‰å¯¦é«”çš„ç‹€æ…‹
    sortableInstances.forEach(inst => {
        inst.option('disabled', isLocked);
    });
}

function updateCounts() {
    let eOff = 0, eNco = 0, eSol = 0;
    let aOff = 0, aNco = 0, aSol = 0;

    people.forEach(p => {
        const rType = getRankType(p.rank);
        if (rType === 'off') eOff++; else if (rType === 'nco') eNco++; else eSol++;
    });

    document.querySelectorAll('.person-card').forEach(card => {
        const pId = card.getAttribute('data-id');
        const person = people.find(p => p.id === pId);
        const zoneId = card.parentElement.id.replace('zone-', '');
        
        if (initialGroups.includes(zoneId) || inCampIncidents.includes(zoneId)) {
            const rType = getRankType(person.rank);
            if (rType === 'off') aOff++; else if (rType === 'nco') aNco++; else aSol++;
        }
    });

    document.getElementById('exp-off').innerText = eOff;
    document.getElementById('exp-nco').innerText = eNco;
    document.getElementById('exp-sol').innerText = eSol;
    document.getElementById('exp-total').innerText = eOff+eNco+eSol;

    document.getElementById('act-off').innerText = aOff;
    document.getElementById('act-nco').innerText = aNco;
    document.getElementById('act-sol').innerText = aSol;
    document.getElementById('act-total').innerText = aOff+aNco+aSol;
}

function saveAllPositions() {
    const pos = {};
    document.querySelectorAll('.person-card').forEach(card => {
        pos[card.getAttribute('data-id')] = card.parentElement.id;
    });
    localStorage.setItem('attendance_pos', JSON.stringify(pos));
    localStorage.setItem('attendance_people', JSON.stringify(people));
}

function resetAll() { if(confirm("ç¢ºå®šä¸€éµæ­¸éšŠï¼Ÿ")) { localStorage.removeItem('attendance_pos'); renderBoard(); } }
function closeModal() { document.getElementById('modal').style.display = 'none'; document.getElementById('overlay').style.display = 'none'; }

function openModal(person = null) {
    if(isLocked) return;
    const delBtn = document.getElementById('btn-delete');
    if (person) {
        document.getElementById('edit-id').value = person.id;
        document.getElementById('p-rank').value = person.rank;
        document.getElementById('p-name').value = person.name;
        document.getElementById('p-group').value = person.home;
        delBtn.style.display = "block";
    } else {
        document.getElementById('edit-id').value = "";
        document.getElementById('p-rank').value = "";
        document.getElementById('p-name').value = "";
        delBtn.style.display = "none";
    }
    document.getElementById('modal').style.display = 'block';
    document.getElementById('overlay').style.display = 'block';
}

function savePerson() {
    const id = document.getElementById('edit-id').value;
    const rank = document.getElementById('p-rank').value;
    const name = document.getElementById('p-name').value;
    const home = document.getElementById('p-group').value;
    if (!rank || !name) return alert("è«‹è¼¸å…¥å®Œæ•´è³‡æ–™");
    if (id) {
        const index = people.findIndex(p => p.id === id);
        people[index] = { id, rank, name, home };
    } else {
        people.push({ id: Date.now().toString(), rank, name, home });
    }
    localStorage.setItem('attendance_people', JSON.stringify(people));
    closeModal(); renderBoard();
}

function deletePerson() {
    if (confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) {
        const id = document.getElementById('edit-id').value;
        people = people.filter(p => p.id !== id);
        localStorage.setItem('attendance_people', JSON.stringify(people));
        closeModal(); renderBoard();
    }
}

const localPeople = localStorage.getItem('attendance_people');
if (localPeople) people = JSON.parse(localPeople);
renderBoard();
</script>
</body>
</html>
