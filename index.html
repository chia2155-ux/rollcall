<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ•¸ä½è¡Œå‹•é»åæ¿ - å…¨æ–¹ä½è‡ªè¨‚ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --group-bg: #e8ecef;
            --in-camp-bg: #fff9c4;
            --off-camp-bg: #ffcdd2;
            --primary: #2c3e50;
            --officer: #ff5252;
            --nco: #fbc02d;
            --soldier: #69f0ae;
        }

        body { 
            font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; 
            background-color: #f5f5f5; 
            margin: 0; 
            padding: 0 8px 100px 8px; 
        }

        .sticky-header {
            position: sticky; top: 0; z-index: 1000;
            background-color: #f5f5f5; padding-top: 8px; padding-bottom: 5px;
        }

        .summary-table {
            width: 100%; background: #fff; border-collapse: collapse;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-radius: 8px; 
            overflow: hidden; text-align: center; font-size: 0.75em;
        }
        .summary-table th { background: #34495e; color: white; padding: 4px; }
        .summary-table td { padding: 6px; font-weight: bold; border: 1px solid #eee; }

        .section-header {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--primary); color: white; padding: 5px 12px;
            margin-top: 12px; border-radius: 5px;
        }
        .section-header button { background: rgba(255,255,255,0.2); color: white; border: 1px solid white; padding: 2px 8px; font-size: 0.75em; }

        .row { display: flex; background: white; border-bottom: 1px solid #ddd; min-height: 50px; }
        .label {
            width: 65px; background: var(--group-bg); display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 0.75em; text-align: center; border-right: 2px solid #ccc; padding: 4px; flex-shrink: 0;
        }
        .in-row .label { background: var(--in-camp-bg); }
        .off-row .label { background: var(--off-camp-bg); }

        .drag-zone { 
            flex-grow: 1; padding: 8px; display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(75px, 1fr)); /* é—œéµï¼šæ¯åˆ—è‡ªå‹•å¡«å……ï¼Œæœ€å°75px */
            gap: 4px; min-height: 40px; 
        }

        .person-card {
            padding: 5px 2px; border-radius: 3px; font-size: 0.8em; text-align: center;
            box-shadow: 1px 1px 2px rgba(0,0,0,0.1); font-weight: bold;
            border: 1px solid rgba(0,0,0,0.05); white-space: nowrap; overflow: hidden;
        }
        .card-officer { background-color: var(--officer); color: white; }
        .card-nco { background-color: var(--nco); color: #222; }
        .card-soldier { background-color: var(--soldier); color: #222; }

        .btn-container {
            position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 8px;
            display: flex; justify-content: space-around; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000;
        }
        button { padding: 8px 10px; border: none; border-radius: 5px; font-weight: bold; font-size: 0.85em; }
        
        #modal, #config-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; box-shadow: 0 0 20px rgba(0,0,0,0.5); z-index: 2000; width: 85%; border-radius: 10px; }
        #overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 1500; }
        input, select { width: 100%; padding: 8px; margin: 8px 0; box-sizing: border-box; }
    </style>
</head>
<body class="unlocked">

<div class="sticky-header">
    <table class="summary-table">
        <thead>
            <tr><th>é …ç›®</th><th>è»</th><th>å£«</th><th>å…µ</th><th>ç¸½è¨ˆ</th></tr>
        </thead>
        <tbody>
            <tr class="row-header"><td>æ‡‰åˆ°</td><td id="exp-off">0</td><td id="exp-nco">0</td><td id="exp-sol">0</td><td id="exp-total">0</td></tr>
            <tr style="color: #2980b9;"><td>åœ¨ç‡Ÿ</td><td id="act-off">0</td><td id="act-nco">0</td><td id="act-sol">0</td><td id="act-total">0</td></tr>
        </tbody>
    </table>
</div>

<div id="board">
    <div class="section-header">
        <span>å·¥ä½œçµ„åˆ¥ (åœ¨ç‡Ÿ)</span>
        <button onclick="openConfig('group')">âš™ï¸ ç®¡ç†</button>
    </div>
    <div id="group-area"></div>

    <div class="section-header" style="background:#f39c12;">
        <span>åœ¨ç‡Ÿäº‹æ•… (é»ƒ)</span>
        <button onclick="openConfig('inCamp')">âš™ï¸ ç®¡ç†</button>
    </div>
    <div id="in-incident-area"></div>

    <div class="section-header" style="background:#d32f2f;">
        <span>ä¸åœ¨ç‡Ÿäº‹æ•… (ç´…)</span>
        <button onclick="openConfig('offCamp')">âš™ï¸ ç®¡ç†</button>
    </div>
    <div id="off-incident-area"></div>
</div>

<div class="btn-container">
    <button id="lock-btn" onclick="toggleLock()" style="background:#f39c12; color:white;">ğŸ”“ è§£é–</button>
    <button onclick="copyReport()" style="background:#8e44ad; color:white;">ğŸ“‹ å›å ±</button>
    <button onclick="openModal()" style="background:#27ae60; color:white;">ï¼‹ äººå“¡</button>
    <button onclick="resetAll()" style="background:#2980b9; color:white;">âŸ² æ­¸éšŠ</button>
</div>

<div id="overlay" onclick="closeAllModals()"></div>
<div id="modal">
    <h3 id="modal-title">äººå“¡ç®¡ç†</h3>
    <input type="hidden" id="edit-id">
    <input type="text" id="p-rank" placeholder="éšç´š">
    <input type="text" id="p-name" placeholder="å§“å">
    <label>é è¨­çµ„åˆ¥ï¼š</label><select id="p-group"></select>
    <div style="display: flex; justify-content: space-between;">
        <button onclick="savePerson()" style="background:#27ae60; color:white;">å„²å­˜</button>
        <button id="btn-delete" onclick="deletePerson()" style="background:#e74c3c; color:white; display:none;">åˆªé™¤</button>
        <button onclick="closeAllModals()">å–æ¶ˆ</button>
    </div>
</div>

<div id="config-modal">
    <h3 id="config-title">ç®¡ç†</h3>
    <div id="config-list" style="max-height: 200px; overflow-y: auto; margin-bottom: 10px;"></div>
    <input type="text" id="new-config-name" placeholder="æ–°å¢åç¨±...">
    <button onclick="addConfigItem()" style="background:#27ae60; color:white; width:100%;">ï¼‹ æ–°å¢é …ç›®</button>
    <hr>
    <button onclick="closeAllModals()" style="width:100%;">å®Œæˆ</button>
</div>

<script>
// --- æ’åºæ¬Šé‡è¨­å®š ---
const rankPriority = {
    'æ ¡': 100, 'å°‰': 90, 'å°‘': 90, 'ä¸­': 85, 'å£«å®˜é•·': 80, 'å£«': 70, 'é•·': 70, 'å…µ': 60
};
function getRankWeight(rank) {
    let weight = 0;
    if (rank.includes('æ ¡')) weight = 1000;
    else if (rank.includes('å°‰')) weight = 900;
    else if (rank.includes('å£«å®˜é•·')) weight = 800;
    else if (rank.includes('å£«')) weight = 700;
    else if (rank.includes('å…µ')) weight = 600;

    if (rank.includes('ä¸Š')) weight += 3;
    else if (rank.includes('ä¸­')) weight += 2;
    else if (rank.includes('ä¸‹') || rank.includes('ä¸€')) weight += 1;
    return weight;
}

// --- åˆå§‹åŒ–è¨­å®š ---
let config = JSON.parse(localStorage.getItem('attendance_config')) || {
    group: ["é€£éƒ¨çµ„","ç‡Ÿéƒ¨çµ„","é€šä¿¡çµ„","æ­¦åŒ–çµ„","é£›é›·çµ„","é€šä¿çµ„","CPçµ„","ä¿é¤Šæ’","å±¥è»Šçµ„","è¼ªè»Šçµ„","é†«å‹™çµ„","é£Ÿå‹¤çµ„","é è²¡çµ„"],
    inCamp: ["è£œä¼‘", "è¡›å“¨", "æˆ°æƒ…", "èª¿åº¦", "å½ˆè—¥", "è»æ¢°", "å‰²è‰"],
    offCamp: ["ä¼‘å‡", "æ´½å…¬", "å—è¨“", "æ”¯æ´", "æ‹›å‹Ÿ", "è¨—ç®¡"]
};

let people = JSON.parse(localStorage.getItem('attendance_people')) || [
    {id: '1', rank: 'ä¸Šå°‰', name: 'åŠ‰ç‚«è‰¯', home: 'é€£éƒ¨çµ„'}, {id: '2', rank: 'ä¸Šå°‰', name: 'åŠ‰æ†é½Š', home: 'é€£éƒ¨çµ„'}, {id: '3', rank: 'ä¸Šå°‰', name: 'æ—å³»é´»', home: 'é€£éƒ¨çµ„'}, {id: '4', rank: 'ä¸Šå…µ', name: 'ææ•è±ª', home: 'é€£éƒ¨çµ„'}, {id: '5', rank: 'ä¸€å…µ', name: 'èŠè¿¦ç¨‹', home: 'é€£éƒ¨çµ„'},
    {id: '6', rank: 'ä¸Šå£«', name: 'æ—åº­å›', home: 'ç‡Ÿéƒ¨çµ„'}, {id: '7', rank: 'ä¸­å£«', name: 'ç¾…å­å»º', home: 'ç‡Ÿéƒ¨çµ„'}, {id: '8', rank: 'ä¸Šå…µ', name: 'æ—å“²ç”·', home: 'ç‡Ÿéƒ¨çµ„'}, {id: '9', rank: 'ä¸Šå…µ', name: 'å³çªéˆº', home: 'ç‡Ÿéƒ¨çµ„'},
    {id: '12', rank: 'ä¸Šå£«', name: 'è¬å€‰ç„', home: 'æ­¦åŒ–çµ„'}, {id: '13', rank: 'ä¸‹å£«', name: 'æ½˜è–éš†', home: 'æ­¦åŒ–çµ„'}
];

let isLocked = false;
let currentConfigType = '';

function renderBoard() {
    const gArea = document.getElementById('group-area');
    const inArea = document.getElementById('in-incident-area');
    const offArea = document.getElementById('off-incident-area');
    const select = document.getElementById('p-group');
    gArea.innerHTML = ''; inArea.innerHTML = ''; offArea.innerHTML = ''; select.innerHTML = '';

    config.group.forEach(g => {
        gArea.innerHTML += `<div class="row"><div class="label">${g}</div><div class="drag-zone" id="zone-${g}"></div></div>`;
        select.innerHTML += `<option value="${g}">${g}</option>`;
    });
    config.inCamp.forEach(i => { inArea.innerHTML += `<div class="row in-row"><div class="label">${i}</div><div class="drag-zone" id="zone-${i}"></div></div>`; });
    config.offCamp.forEach(o => { offArea.innerHTML += `<div class="row off-row"><div class="label">${o}</div><div class="drag-zone" id="zone-${o}"></div></div>`; });

    const savedPos = JSON.parse(localStorage.getItem('attendance_pos')) || {};
    people.forEach(p => {
        const card = createCard(p);
        const currentZoneId = savedPos[p.id] || `zone-${p.home}`;
        const targetZone = document.getElementById(currentZoneId);
        if (targetZone) targetZone.appendChild(card);
    });

    document.querySelectorAll('.drag-zone').forEach(zone => sortChildren(zone));
    initSortable();
    updateCounts();
}

function createCard(p) {
    const card = document.createElement('div');
    const weight = getRankWeight(p.rank);
    let cls = 'card-soldier';
    if (weight >= 900) cls = 'card-officer';
    else if (weight >= 700) cls = 'card-nco';
    
    card.className = `person-card ${cls}`;
    card.id = `person-${p.id}`;
    card.innerText = `${p.rank} ${p.name}`;
    card.setAttribute('data-id', p.id);
    card.setAttribute('data-weight', weight);
    card.onclick = (e) => { if(!isLocked) { e.stopPropagation(); openModal(p); } };
    return card;
}

function sortChildren(container) {
    const items = Array.from(container.children);
    items.sort((a, b) => b.getAttribute('data-weight') - a.getAttribute('data-weight'));
    items.forEach(item => container.appendChild(item));
}

function initSortable() {
    document.querySelectorAll('.drag-zone').forEach(zone => {
        new Sortable(zone, {
            group: 'attendance', animation: 150, scroll: true, forceFallback: true,
            disabled: isLocked,
            onEnd: (evt) => { 
                sortChildren(evt.to); 
                saveAllPositions(); 
                updateCounts(); 
            }
        });
    });
}

// --- å€åŸŸç®¡ç†åŠŸèƒ½ ---
function openConfig(type) {
    currentConfigType = type;
    document.getElementById('config-title').innerText = "ç®¡ç†é …ç›®";
    const list = document.getElementById('config-list');
    list.innerHTML = '';
    config[type].forEach((item, index) => {
        list.innerHTML += `<div style="display:flex; justify-content:space-between; margin-bottom:5px;">
            <span>${item}</span>
            <button onclick="deleteConfigItem(${index})" style="background:#e74c3c; color:white; padding:2px 5px;">åˆªé™¤</button>
        </div>`;
    });
    document.getElementById('config-modal').style.display = 'block';
    document.getElementById('overlay').style.display = 'block';
}

function addConfigItem() {
    const name = document.getElementById('new-config-name').value;
    if(!name) return;
    config[currentConfigType].push(name);
    localStorage.setItem('attendance_config', JSON.stringify(config));
    document.getElementById('new-config-name').value = '';
    openConfig(currentConfigType);
    renderBoard();
}

function deleteConfigItem(index) {
    if(confirm("åˆªé™¤è©²é …ç›®å¯èƒ½å°è‡´äººå“¡ä½ç½®é‡ç½®ï¼Œç¢ºå®šå—ï¼Ÿ")) {
        config[currentConfigType].splice(index, 1);
        localStorage.setItem('attendance_config', JSON.stringify(config));
        openConfig(currentConfigType);
        renderBoard();
    }
}

// --- å…¶ä»–åŠŸèƒ½å‡½æ•¸ (é–å®šã€çµ±è¨ˆã€å›å ±ç­‰) ---
function toggleLock() {
    isLocked = !isLocked;
    const btn = document.getElementById('lock-btn');
    btn.innerText = isLocked ? "ğŸ”’ é–å®šä¸­" : "ğŸ”“ è§£é–ä¸­";
    renderBoard();
}

function updateCounts() {
    let eOff = 0, eNco = 0, eSol = 0;
    let aOff = 0, aNco = 0, aSol = 0;
    people.forEach(p => {
        const w = getRankWeight(p.rank);
        if (w >= 900) eOff++; else if (w >= 700) eNco++; else eSol++;
    });
    document.querySelectorAll('.person-card').forEach(card => {
        const pId = card.getAttribute('data-id');
        const p = people.find(x => x.id === pId);
        const zoneId = card.parentElement.id.replace('zone-', '');
        if (config.group.includes(zoneId) || config.inCamp.includes(zoneId)) {
            const w = getRankWeight(p.rank);
            if (w >= 900) aOff++; else if (w >= 700) aNco++; else aSol++;
        }
    });
    document.getElementById('exp-off').innerText = eOff; document.getElementById('exp-nco').innerText = eNco; document.getElementById('exp-sol').innerText = eSol; document.getElementById('exp-total').innerText = eOff+eNco+eSol;
    document.getElementById('act-off').innerText = aOff; document.getElementById('act-nco').innerText = aNco; document.getElementById('act-sol').innerText = aSol; document.getElementById('act-total').innerText = aOff+aNco+aSol;
}

function copyReport() {
    let r = `ã€${new Date().getMonth()+1}/${new Date().getDate()} å›å ±ã€‘\næ‡‰åˆ°ï¼šè»${document.getElementById('exp-off').innerText} å£«${document.getElementById('exp-nco').innerText} å…µ${document.getElementById('exp-sol').innerText} (${document.getElementById('exp-total').innerText})\nåœ¨ç‡Ÿï¼šè»${document.getElementById('act-off').innerText} å£«${document.getElementById('act-nco').innerText} å…µ${document.getElementById('act-sol').innerText} (${document.getElementById('act-total').innerText})\n`;
    config.offCamp.forEach(o => {
        const cards = document.getElementById(`zone-${o}`).querySelectorAll('.person-card');
        if(cards.length > 0) r += `â— ${o}(${cards.length}å“¡)ï¼š${Array.from(cards).map(c=>c.innerText.split(' ')[1]).join('ã€')}\n`;
    });
    const el = document.createElement('textarea'); el.value = r; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el);
    alert("å·²è¤‡è£½ï¼");
}

function saveAllPositions() {
    const pos = {};
    document.querySelectorAll('.person-card').forEach(card => { pos[card.getAttribute('data-id')] = card.parentElement.id; });
    localStorage.setItem('attendance_pos', JSON.stringify(pos));
    localStorage.setItem('attendance_people', JSON.stringify(people));
}

function closeAllModals() { document.getElementById('modal').style.display='none'; document.getElementById('config-modal').style.display='none'; document.getElementById('overlay').style.display='none'; }
function openModal(p = null) {
    const delBtn = document.getElementById('btn-delete');
    if (p) {
        document.getElementById('edit-id').value = p.id; document.getElementById('p-rank').value = p.rank; document.getElementById('p-name').value = p.name; document.getElementById('p-group').value = p.home; delBtn.style.display = "block";
    } else {
        document.getElementById('edit-id').value = ""; document.getElementById('p-rank').value = ""; document.getElementById('p-name').value = ""; delBtn.style.display = "none";
    }
    document.getElementById('modal').style.display = 'block'; document.getElementById('overlay').style.display = 'block';
}
function savePerson() {
    const id = document.getElementById('edit-id').value;
    const rank = document.getElementById('p-rank').value;
    const name = document.getElementById('p-name').value;
    const home = document.getElementById('p-group').value;
    if (id) {
        const i = people.findIndex(x => x.id === id); people[i] = { id, rank, name, home };
    } else {
        people.push({ id: Date.now().toString(), rank, name, home });
    }
    localStorage.setItem('attendance_people', JSON.stringify(people));
    closeAllModals(); renderBoard();
}
function deletePerson() { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { const id = document.getElementById('edit-id').value; people = people.filter(x => x.id !== id); localStorage.setItem('attendance_people', JSON.stringify(people)); closeAllModals(); renderBoard(); } }
function resetAll() { if(confirm("æ­¸éšŠï¼Ÿ")) { localStorage.removeItem('attendance_pos'); renderBoard(); } }

renderBoard();
</script>
</body>
</html>
